# メールOTPサインアップ・ログインフロー
# Inbucket APIを使ってOTPを自動取得し、新規ユーザーとしてサインアップする
#
# 前提:
#   - ローカルSupabase起動済み（Inbucket有効、port 54324）
#   - 環境変数 TEST_EMAIL, INBUCKET_URL が設定されている
#   - アプリがホーム画面を表示している状態（未ログイン）
#
# 使い方:
#   maestro test -e TEST_EMAIL=e2e-test@example.com -e INBUCKET_URL=http://localhost:54324
#   ---
#   - runFlow: _common/login_with_email.yaml

appId: com.tyatsushi.machikore
---

# マイページタブをタップ → 「街コレへようこそ」画面
- tapOn:
    id: "tab-mypage"

- extendedWaitUntil:
    visible: "街コレへようこそ"
    timeout: 5000

# 「アカウントを作成」ボタンをタップ → SignUpPage
- tapOn:
    text: "アカウントを作成"

- extendedWaitUntil:
    visible: ".*メールアドレス.*"
    timeout: 15000

# 「メールアドレスで登録」をタップ → フォーム展開
- tapOn:
    text: ".*メールアドレス.*"

# メールアドレスを入力
- tapOn:
    id: "email-input"

- inputText: ${TEST_EMAIL}

# キーボードを閉じて送信ボタンを表示
- hideKeyboard

# 「登録用コードを送信」をタップ
- tapOn:
    id: "send-code-button"

# OTP入力画面が表示されるまで待つ
- extendedWaitUntil:
    visible:
      id: "otp-input"
    timeout: 15000

# Inbucket APIからOTPを取得（スクリプト内でリトライしてメール配信を待つ）
- runScript:
    file: ../../scripts/get_otp_from_inbucket.js
    env:
      INBUCKET_URL: ${INBUCKET_URL}
      TEST_EMAIL: ${TEST_EMAIL}

# OTPを入力
- tapOn:
    id: "otp-input"

- inputText: ${output.otp}

# 「認証する」をタップ
- tapOn:
    id: "verify-button"

# 認証処理が完了するまで待つ（verify-buttonが消えることで判定）
- extendedWaitUntil:
    notVisible:
      id: "verify-button"
    timeout: 10000
