#街コレ - 要件定義書

## 目次
- [1. プロジェクト概要](#1-プロジェクト概要)
- [2. 機能要件](#2-機能要件)
  - [2.1 コア機能](#21-コア機能)
  - [2.2 無料版 vs 有料版](#22-無料版-vs-有料版)
- [3. 非機能要件](#3-非機能要件)
- [4. 技術要件](#4-技術要件)
- [5. 画面構成](#5-画面構成)
- [6. データ同期要件](#6-データ同期要件)
- [7. 制約事項](#7-制約事項)
- [8. 成功指標（KPI）](#8-成功指標kpi)
- [9. リリース計画](#9-リリース計画)
- [10. 補足](#10-補足)

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
**街コレ (MachiKore)**

### 1.2 目的
街（初期は東京）への訪問記録を残し、訪問予定を管理できるモバイルアプリケーション。
ユーザーは街ごとの訪問履歴を地図上で視覚的に管理し、SNS的な投稿機能で記録を振り返ることができる。

### 1.3 ターゲットユーザー
- 街を旅したことを記録したい人
- 訪問した場所を友達と共有したい人
- 東京の街を制覇したい人
- 旅の思い出を写真と共に残したい人

### 1.4 対応プラットフォーム
- iOS
- Android

---

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 地図（マップ）機能
- **街マーカー表示**
  - 東京都内の全ての街（JR、私鉄、地下鉄）にマーカーを配置
  - 未訪問の街：デフォルトピン表示（例：グレーのピン）
  - 訪問済みの街：専用アイコン表示
    - 1回訪問：青いチェックマークアイコン
    - 2回訪問：紫のスターアイコン
    - 3回以上訪問：オレンジのトロフィーアイコン

- **友達の訪問場所表示**
  - 同期している友達が訪問した街にもアイコン表示
  - 自分と友達の両方が訪問した街は複合表示（例：重なったアイコン）
  - 友達のアイコンは半透明で表示し、区別可能に
  - 無料版：1人まで表示可能、有料版：無制限

- **訪問記録の登録**
  - 街マーカーをタップして手動で訪問記録を登録
  - 同一街への複数回訪問に対応（1回目、2回目、3回目...とカウント）
  - 訪問記録登録時にアイコンが即座に変化
  - 訪問記録作成と同時に自動生成投稿がスレッドに追加

- **訪問詳細の表示**
  - マーカータップ時にボトムシートで以下を表示：
    - 街名
    - 訪問日時（全ての訪問履歴）
    - 訪問回数
    - 関連する投稿・写真
    - 友達の訪問情報（無料版：1人まで、有料版：無制限）

- **訪問記録の削除**
  - 訪問詳細ボトムシートから特定の訪問記録を削除可能
  - 訪問記録を削除すると、関連する全ての投稿（自動生成 + 手動）も連鎖削除
  - 削除時に確認ダイアログを表示
  - 削除後、地図のアイコンが即座に更新

- **地図操作**
  - ピンチイン/アウトでズーム
  - スワイプで地図移動
  - 現在地表示ボタン
  - フィルター機能（自分のみ / 友達含む）
    - 無料版：自分 + 友達1人まで選択可能
    - 有料版：無制限

#### 2.1.2 スレッド（タイムライン）機能
- **投稿の自動生成**
  - 街訪問記録を登録した瞬間、自動で投稿を生成
  - 投稿内容：「〇〇に訪問しました（n回目）」+ 日時
  - 訪問記録と投稿は`posts.visit_id`で関連付け
  - 自動生成投稿には`is_auto_generated = true`フラグを設定

- **手動投稿**
  - ユーザーが任意のタイミングで投稿可能
  - テキスト入力（最大500文字）
  - 写真添付（最大4枚）
  - 訪問した街との紐付け（任意）
  - 訪問に紐付けない独立した投稿も作成可能

- **投稿の編集・削除**
  - 自分の投稿を編集可能
  - **手動投稿の削除**: その投稿のみ削除（訪問記録は残る）
  - **自動生成投稿の削除**: 訪問記録 + 紐付いた全手動投稿を連鎖削除
  - 削除時に確認ダイアログを表示

- **投稿の閲覧**
  - タイムライン形式（新しい順）
  - 投稿に添付された写真を表示
  - 日付でフィルタリング可能
  - **無限スクロール**: 下にスクロールで過去の投稿を自動読み込み（20件ずつ）
  - **Pull-to-refresh**: 上部スクロールで最新データを取得
    - Supabaseから最新データを取得してSQLiteキャッシュを更新
    - 友達の投稿も同時に取得（無料版は1人まで、有料版は無制限）
    - Supabase Realtimeでリアルタイム通知（友達が投稿した瞬間に通知）

- **いいね機能**
  - 投稿に対していいね可能（有料版で友達機能解放時に活用）

- **返信機能**
  - 投稿に対して返信可能（有料版で友達機能解放時に活用）

#### 2.1.3 投稿作成機能（中央タブ）
- **新規投稿作成**
  - テキスト入力
  - 写真アップロード（カメラ起動 or ギャラリーから選択）
  - 街の選択（任意）
  - 投稿プレビュー

- **下書き保存**
  - 投稿途中で保存可能
  - 下書き一覧から再編集可能

#### 2.1.4 カレンダー機能
- **月間カレンダー表示**
  - 月ごとのカレンダービュー
  - 訪問記録がある日にマーカー表示
  - 予定がある日にマーカー表示

- **ユーザー切り替え機能**
  - ヘッダーにドロップダウンメニューを配置
  - 表示対象ユーザーを選択可能：
    - 自分
    - 同期中の友達（個別選択）
    - 無料版：1人まで選択可能、有料版：無制限
  - 選択したユーザーのカレンダーを表示
  - 友達のカレンダーは閲覧のみ（編集不可）

- **日付詳細表示**
  - 特定の日をタップすると以下を表示：
    - その日に訪問した街
    - その日の投稿
    - その日の予定（未来の場合）
  - 友達のカレンダー表示時：
    - 友達がその日に訪問した街
    - 友達のその日の投稿（公開設定の場合）

- **予定の登録**
  - 「どこの街に行く予定」という形式で登録
  - 予定日時、メモを追加可能
  - 自分のカレンダーのみ登録可能

- **予定の編集・削除**
  - 登録済み予定を編集・削除可能
  - 自分の予定のみ編集・削除可能

#### 2.1.5 マイページ機能
- **プロフィール表示**
  - ユーザー名
  - プロフィール画像
  - 訪問街数の統計
  - 総投稿数

- **設定**
  - アカウント設定
  - 通知設定
  - プライバシー設定
  - アプリバージョン情報

- **訪問統計**
  - 訪問した街の路線別グラフ
  - 訪問数の推移グラフ
  - 達成バッジ（例：「山手線制覇」など）

- **有料版へのアップグレード**
  - 有料版の機能説明
  - サブスクリプション購入フロー

---

### 2.2 無料版 vs 有料版

#### 2.2.1 無料版
- **データ保存**：Supabase + SQLite（ローカルキャッシュ）
- **利用範囲**：友達追加1人まで
- **画像保存**：Supabase Storage（ローカルキャッシュあり）
- **広告表示**：あり
- **認証**：Supabase Anonymous Auth（アカウント登録不要）
- **提供機能**：
  - 地図機能（全機能）
  - スレッド機能（自分 + 友達1人まで）
  - 投稿作成機能
  - カレンダー機能
  - マイページ（基本機能）
  - 友達の投稿閲覧（1人まで）
  - いいね・返信機能
  - オフライン対応（自動同期）

#### 2.2.2 有料版（サブスクリプション）
- **データ保存**：Supabase + SQLite（ローカルキャッシュ）
- **利用範囲**：友達追加無制限
- **画像保存**：Supabase Storage（ローカルキャッシュあり）
- **広告表示**：なし
- **認証**：Supabase Email/Social Auth（アカウント登録必要）
- **追加機能**：
  - **友達同期機能（無制限）**
    - ID検索で友達を検索
    - 同期リクエスト送信
    - 相互承認制の同期関係構築
    - 同期中の友達一覧表示
  - **友達のタイムライン統合**
    - スレッドページに友達の投稿も表示
    - 友達の投稿にいいね・返信可能
  - **匿名アカウント移行**
    - 無料版（匿名）→有料版（登録）移行時に既存データを自動移行
    - アカウント紐付け完了後、匿名セッションを削除
  - **クロスデバイス同期**
    - 複数端末でのデータ同期
  - **優先サポート**
    - 問い合わせ対応優先

---

## 3. 非機能要件

### 3.1 パフォーマンス
- アプリ起動時間：3秒以内
- 地図読み込み時間：2秒以内
- 投稿作成から表示まで：1秒以内（ローカル）
- オフライン時も主要機能が利用可能

### 3.2 セキュリティ
- Supabase認証による安全なユーザー認証
- 画像データの暗号化保存（Supabase Storage）
- ローカルデータベース（SQLite）の暗号化検討

### 3.3 ユーザビリティ
- 直感的なUI/UX
- タブナビゲーションで主要機能に素早くアクセス
- オフライン時の適切なフィードバック表示
- ローディング状態の明示

### 3.4 拡張性
- 将来的に東京以外の都市への拡張を想定した設計
- 新機能追加に対応できるモジュラーアーキテクチャ（FSD）
- APIバージョニング対応

### 3.5 オフライン対応（Offline-First Architecture）
- **基本方針**：全データをローカル（SQLite）にキャッシュし、Supabaseと双方向同期
- **地図・街データ**：常時閲覧可能（静的データ、アプリ組み込み）
- **投稿・訪問記録**：
  - オフライン時：SQLiteに書き込み、`is_synced = 0`フラグを設定
  - オンライン復帰時：同期キュー（sync_queue）から未同期データをSupabaseにアップロード
  - 同期成功後：`is_synced = 1`に更新
- **画像**：
  - オフライン時：`FileSystem.documentDirectory/images/`にローカル保存
  - オンライン復帰時：Supabase Storageに遅延アップロード
  - ローカルキャッシュは削除しない（高速表示のため）
- **ネットワーク障害時の対応**：
  - 同期失敗時は自動リトライ（指数バックオフ）
  - ユーザーに同期状態を通知（同期中・完了・失敗）
  - 手動同期ボタンの提供
- **匿名ユーザーの同期**：
  - 無料版でもSupabase Anonymous Authで認証
  - 匿名ユーザーのデータもSupabaseに保存（friends制限のみ適用）

---

## 4. 技術要件

### 4.1 フロントエンド
- **フレームワーク**: React Native + Expo
- **ルーティング**: Expo Router（ファイルベースルーティング）
- **アーキテクチャ**: Feature-Sliced Design (FSD)
- **状態管理**:
  - Zustand（グローバル状態）
  - Zustand Persist（UI状態・設定の永続化）
- **データフェッチング**: React Query（Supabase同期 + SQLiteキャッシュ）
- **地図**: react-native-maps
- **UI**: React Native Paper または Tamagui
- **ストレージ**:
  - expo-secure-store（認証トークン）
  - @react-native-async-storage/async-storage（UI状態・設定）
  - expo-file-system（画像ローカルキャッシュ）

### 4.2 バックエンド
- **認証**: Supabase Auth
  - **無料版**: Anonymous Auth（自動生成UUID、永続化）
  - **有料版**: Email/Social Auth（Google, Apple）
  - **移行機能**: 匿名ユーザー → 登録ユーザーへのデータ移行
- **データベース（クラウド）**: Supabase (PostgreSQL)
- **ストレージ**: Supabase Storage
- **リアルタイム同期**: Supabase Realtime（全ユーザー対応）

### 4.3 ローカルデータベース（キャッシュ層）
- **SQLite**: expo-sqlite
- **役割**: Supabaseのローカルキャッシュ + オフライン対応
- **同期フラグ**: 各テーブルに`is_synced`カラムを追加
- **同期キュー**: `sync_queue`テーブルで未同期操作を管理
- **ORM検討**: Drizzle ORM または手動SQL

### 4.4 データ同期アーキテクチャ
- **書き込み**: SQLite → 同期キュー → Supabase（オンライン時）
- **読み込み**: SQLite（キャッシュ） → フォールバック Supabase
- **競合解決**: Last-Write-Wins（`updated_at`タイムスタンプで判定）
- **ネットワーク監視**: `@react-native-community/netinfo`

### 4.5 街データ
- **データソース**: 国土交通省「国土数値情報（鉄道データ）」
- **管理方法**: ビルド時に静的データとして組み込み
- **更新方法**: アプリアップデートで対応

---

## 5. 画面構成

### 5.1 タブナビゲーション（下部）
```
[マップ] [スレッド] [投稿] [カレンダー] [マイページ]
```

### 5.2 画面一覧
1. **マップ画面** - 地図と街フラグ表示
2. **スレッド画面** - タイムライン表示
3. **投稿作成画面** - 新規投稿作成
4. **カレンダー画面** - 月間カレンダーと予定管理
5. **マイページ画面** - プロフィールと設定
6. **街詳細モーダル** - 街の訪問履歴詳細
7. **投稿詳細モーダル** - 投稿の詳細・返信
8. **日付詳細モーダル** - 特定日の記録・予定
9. **設定画面** - 各種設定
10. **友達一覧画面** - 同期中の友達（無料版：1人まで、有料版：無制限）
11. **友達検索画面** - ID検索（無料版：1人まで追加可能、有料版：無制限）
12. **広告表示画面**（無料版のみ） - インタースティシャル広告またはバナー広告

---

## 6. データ同期要件

### 6.1 Offline-First同期フロー
1. **書き込み操作（Create/Update/Delete）**
   - SQLiteに即座に書き込み
   - `is_synced = 0`フラグを設定
   - `sync_queue`テーブルに操作を記録（操作種別、テーブル名、レコードID）
   - オンライン時：バックグラウンドでSupabaseに同期
   - 同期成功後：`is_synced = 1`に更新、`sync_queue`から削除

2. **読み込み操作（Read）**
   - SQLiteから読み込み（高速）
   - バックグラウンドでSupabaseから最新データを取得
   - 差分があればSQLiteを更新（`updated_at`タイムスタンプで判定）

3. **画像同期**
   - ローカル保存：`FileSystem.documentDirectory/images/`
   - オンライン時：Supabase Storageに遅延アップロード
   - ローカルキャッシュは保持（削除しない）

4. **競合解決**
   - Last-Write-Wins方式（`updated_at`が新しい方を採用）
   - 将来的にはCRDT（Conflict-free Replicated Data Type）を検討

### 6.2 匿名アカウント→登録アカウント移行
1. **移行トリガー**：有料版購入時またはアカウント登録時
2. **移行プロセス**：
   - 匿名ユーザーの全データ（visits, posts, schedules, images）を保持
   - Supabase Auth: 匿名セッション → Email/Social Auth紐付け
   - `users.id`は変更せず、認証情報のみ更新
   - 移行完了後、匿名セッションを削除
3. **移行中の表示**：プログレスバーで進捗表示
4. **ロールバック**：移行失敗時は匿名状態に戻す

### 6.3 Zustandによる状態同期
- マップ、スレッド、カレンダー間でデータを同期
- 訪問記録の登録 → 全画面に即座に反映
- 投稿作成 → スレッド・カレンダーに即座に反映
- React Queryのキャッシュ無効化により自動リフレッシュ

---

## 7. 制約事項

### 7.1 初期リリース
- 対象エリア：東京都のみ
- プラットフォーム：iOS、Android
- 言語：日本語のみ

### 7.2 将来の拡張
- 他都市への拡張（大阪、名古屋など）
- 多言語対応（英語など）
- Webバージョン

---

## 8. 成功指標（KPI）

### 8.1 ユーザーエンゲージメント
- DAU（Daily Active Users）
- 平均訪問街数/ユーザー
- 平均投稿数/ユーザー

### 8.2 有料版コンバージョン
- 無料版→有料版の転換率
- 有料版継続率（月次）

### 8.3 アプリ品質
- クラッシュ率 < 1%
- アプリレビュー評価 > 4.0

---

## 9. リリース計画

### 9.1 フェーズ1（MVP）
- 基本機能の実装
  - 地図、スレッド、投稿作成、カレンダー、マイページ
  - 訪問記録、投稿、予定管理
- 東京都の街データ
- ハイブリッドアーキテクチャ（Supabase + SQLite）
- Supabase Anonymous Auth（無料版）
- 友達機能（1人まで制限）
- 広告表示（無料版）

### 9.2 フェーズ2
- 有料版機能の拡張
  - 友達追加無制限
  - 広告非表示
  - Email/Social Auth
  - 匿名→登録アカウント移行機能
- サブスクリプション実装（App Store / Google Play）
- Supabase Realtime（友達の投稿通知）

### 9.3 フェーズ3
- 他都市への拡張（大阪、名古屋など）
- 追加機能
  - 達成バッジシステム
  - ルート記録（訪問順序の保存）
  - ストーリー機能（24時間限定投稿）
  - プライベートグループ

---

## 10. 補足

### 10.1 訪問記録と投稿の関係

#### データモデル
```
訪問記録 (visits)
  ├─ 自動生成投稿 (is_auto_generated = true)  [1対1]
  └─ 手動投稿 (is_auto_generated = false)     [1対多]
```

#### 作成フロー
1. 街マーカーをタップして訪問記録を登録
2. 訪問記録（visit）が作成される
3. 自動生成投稿が作成される（`is_auto_generated = true`）
4. ユーザーは追加で手動投稿を作成可能（同じ`visit_id`に紐付け）

#### 削除ルール
- **手動投稿のみ削除**: その投稿のみ削除（訪問記録と自動生成投稿は残る）
- **自動生成投稿を削除**: 訪問記録 + 紐付いた全手動投稿を連鎖削除
- **地図から訪問記録を削除**: 自動生成投稿 + 紐付いた全手動投稿を連鎖削除
- データベースレベルで`ON DELETE CASCADE`を使用

#### 例：同一街への複数回訪問
「新宿」に3回訪問した場合：
- 訪問記録×3（それぞれ独立）
- 自動生成投稿×3（「新宿街に訪問しました（1回目）」「（2回目）」「（3回目）」）
- 2回目の訪問の自動投稿を削除 → 2回目の訪問記録のみ削除、1回目と3回目は残る

#### その他の特性
- 訪問記録は**手動登録**（位置情報による自動判定は行わない）
- 訪問に紐付かない独立した投稿も作成可能（`visit_id = NULL`）

### 10.2 画像管理のベストプラクティス（ハイブリッド方式）
- **全ユーザー共通：Supabase Storage + ローカルキャッシュ**
  - 画像実体：
    - ローカルキャッシュ：`FileSystem.documentDirectory/images/`
    - クラウド：Supabase Storage（`posts/`, `avatars/`バケット）
  - SQLiteには両方のパスを保存：
    - `local_path`: ローカルファイルシステムURI
    - `cloud_path`: Supabase Storage URL（同期後に設定）
  - 形式：`post_<postId>_<timestamp>.jpg`
- **アップロードフロー**：
  1. 画像選択時：ローカルに即座に保存
  2. `is_synced = 0`フラグを設定
  3. オンライン時：バックグラウンドでSupabase Storageにアップロード
  4. 同期成功後：`cloud_path`を更新、`is_synced = 1`に設定
- **表示優先度**：
  1. ローカルキャッシュがあれば使用（高速）
  2. なければSupabase Storageから取得してキャッシュ
- **匿名ユーザーの画像**：
  - 匿名ユーザーでもSupabase Storageに保存
  - RLS（Row Level Security）で自分の画像のみアクセス可能

### 10.3 街データ管理
- 静的データとしてアプリに組み込み（オフライン対応）
- 新しい街の追加時はアプリアップデートで対応
- データ形式：GeoJSON または独自JSON形式

### 10.4 認証セッション管理
- **永続化**：expo-secure-storeを使用
- **自動ログイン**：アプリ再起動時にセッション復元
- **セキュリティ**：セッショントークンを暗号化して保存
- **有効期限**：Supabaseのトークンリフレッシュ機能を活用

### 10.5 ハイブリッドデータ構成（Offline-First）
```
全体アーキテクチャ:

┌──────────────────────────────────────────────────────────────┐
│                    Supabase (Cloud)                          │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ PostgreSQL (Master)                                    │  │
│  │ - users, visits, posts, schedules, images, friends    │  │
│  └────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Supabase Storage                                       │  │
│  │ - posts/ (投稿画像)                                    │  │
│  │ - avatars/ (プロフィール画像)                          │  │
│  └────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ Realtime Subscriptions                                 │  │
│  │ - 友達の投稿リアルタイム通知                           │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
                          ↕ 同期
┌──────────────────────────────────────────────────────────────┐
│               Local Device (Offline-First)                   │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ SQLite Database (machikore.db) ※キャッシュ層           │  │
│  │ - users (is_synced フラグあり)                         │  │
│  │ - visits (is_synced フラグあり)                        │  │
│  │ - posts (is_synced フラグあり)                         │  │
│  │ - schedules (is_synced フラグあり)                     │  │
│  │ - images (local_path, cloud_path, is_synced)           │  │
│  │ - friends (キャッシュ)                                 │  │
│  │ - sync_queue (未同期操作の管理)                        │  │
│  └────────────────────────────────────────────────────────┘  │
│                        ↓ 参照                                │
│  ┌────────────────────────────────────────────────────────┐  │
│  │ FileSystem.documentDirectory/images/ (画像キャッシュ)  │  │
│  │    ├── post_abc123_1234567.jpg                         │  │
│  │    ├── avatar_user1.jpg                                │  │
│  │    └── ...                                             │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘

同期フロー:
1. 書き込み: App → SQLite (is_synced=0) → sync_queue → Supabase
2. 読み込み: App ← SQLite (キャッシュ) ← Supabase (バックグラウンド更新)
3. オフライン: App ↔ SQLite のみ（Supabase同期は待機）
4. オンライン復帰: sync_queue の未同期データをSupabaseに一括送信
```
